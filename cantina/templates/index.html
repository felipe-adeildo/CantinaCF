{% extends "base.html" %}

{% block title %}
    Vendas
{% endblock title %}

{% block content %}
    <div class="toast-container"></div>

    <div class="search-bar">
        <input type="text" id="product-search" oninput="searchProducts()" placeholder="Pesquisar produtos..." />
    </div>

    <div class="product-list">
        <table class="striped">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nome</th>
                    <th>Valor</th>
                    <th>Tipo</th>
                    <th>Quantidade</th>
                    <th>Adicionar ao Carrinho</th>
                </tr>
            </thead>
            <tbody>
                {% for product in products %}
                    <tr>
                        <td>{{ product.id }}</td>
                        <td>{{ product.nome }}</td>
                        <td>R$ {{ product.valor }}</td>
                        <td>{{ product.tipo }}</td>
                        <td id="product-quantity-{{ product.id }}">{{ product.quantidade }}</td>
                        <td>
                            <button class="btn btn-floating waves-effect waves-light center" onclick="addToCart({{ product.id }})">
                                <i class="material-icons">add</i>
                            </button>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <div class="">
        <div class="row">
            <ul id="cart-list" class="collection with-header">
                <li class="collection-header" id="carrinho-title"><h4>Carrinho - R$ <span id="cart-total">0.00</span></h4></li>
            </ul>
        </div>

        <a href="{{ url_for('confirm_purchase', comprar=true) }}" class="btn">Confirmar Compra</a>
    </div>
{% endblock content %}

{% block scripts %}
    <script>
        function searchProducts() {
            var query = document.getElementById('product-search').value;
            var urlSearchProducts = "{{ url_for('search_products') }}";

            fetch(urlSearchProducts, {
                method: "POST",
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    query: query
                })
            })
            .then(response => response.json())
            .then(data => {
                var productTableBody = document.querySelector('.product-list tbody');
                productTableBody.innerHTML = '';
                // data is a list
                data.forEach(product => {
                    var row = document.createElement("tr");
                    row.innerHTML = `
                        <tr>
                            <td>${product.id}</td>
                            <td>${product.nome}</td>
                            <td>${product.valor}</td>
                            <td>${product.tipo}</td>
                            <td id="product-quantity-${product.id}">${product.quantidade}</td>
                            <td>
                                <button class="btn btn-floating waves-effect waves-light center" onclick="addToCart(${product.id})">
                                    <i class="material-icons">add</i>
                                </button>
                            </td>
                        </tr>
                    `;
                    productTableBody.appendChild(row);
                });
            })
            .catch((error) => {
                console.error('Error:', error);
            });
        }

        function addToCart(id) {
            var urlAddToCart = "{{ url_for('add_to_cart') }}";

            fetch(urlAddToCart, {
                method: "POST",
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    id: id,
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.ok) {
                    M.toast({html: `${data.message}`});
                    var cartList = document.getElementById('cart-list');
                    var divItem = document.createElement('div');
                    divItem.className = "col s3";
                    divItem.innerHTML = `<li class="collection-item">${data.product.nome}</li>`;
                    cartList.appendChild(divItem);
                    
                    var totalSpan = document.getElementById('cart-total');
                    var total = parseFloat(totalSpan.innerText) + data.product.valor;
                    totalSpan.innerText = total.toFixed(2);

                    var quantidadeTag = document.getElementById(`product-quantity-${data.product.id}`);
                    quantidadeTag.innerText = data.product.quantidade;

                } else {
                    M.toast({html: 'Algo deu errado.'});
                }
            })
            .catch((error) => {
                console.error(error);
            });
        }

    </script>
{% endblock scripts %}
