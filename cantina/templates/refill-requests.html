{% extends 'base.html' %}

{% block title %}
Pedidos de Recargas
{% endblock %}

{% block content %}
<style>
    .modal {
        height: 80vh;
    }

    .modal-content {
        height: 75%;
        overflow-y: auto;
    }
    .modal-footer {
        height: 5%;
    }

</style>

<div class="container">
    <h4 class="center-align">Pedidos de Recargas</h4>
    {% if refill_requests %}
    {% for request in refill_requests %}
    <div class="row" id="request-{{ request.id }}">
        <div class="col s12 m6 l4">
            <div class="card blue-grey darken-1">
                <div class="card-content white-text">
                    <span class="card-title">{{ request.aluno.name }}</span>
                    <p>Data e Hora: {{ request.data_hora }}</p>
                    <p>Turno: {{ request.turno }}</p>
                    <p>Tipo de Pagamento: {{ request.tipo_pagamento }}</p>
                    <p>Valor: R$ {{ request.valor }}</p>
                    <p>Turma: {{ request.aluno.turma }}</p>
                    <p>Serie: {{ request.aluno.serie }}</p>
                    <p>CPF: {{ request.aluno.cpf }}</p>
                    <p>Username: {{ request.aluno.username }}</p>
                </div>
                <div class="card-action">
                    <a href="#" onclick="manageRefillRequest('{{ request.id }}', true)">Liberar Saldo</a>
                    <a href="#" onclick="manageRefillRequest('{{ request.id }}', false)">Rejeitar Saldo</a>
                    <a href="#" onclick="openModal('{{ request.comprovante_url }}')">Ver Comprovante</a>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
    {% else %}
    <h6 class="red-text center-align">Sem Pedidos de recargas at√© o momento</h6>
    {% endif %}

    <div class="modal" id="modal-comprovante">
        <div class="modal-content">
            <iframe id="comprovante-frame" style="width: 100%; height: 100%;"></iframe>
        </div>
        <div class="modal-footer">
            <a href="#" class="modal-action modal-close waves-effect waves-green btn-flat">Fechar</a>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script>
function openModal(url) {
    document.getElementById("comprovante-frame").src = url;
    let instance = M.Modal.getInstance(document.getElementById('modal-comprovante'));
    instance.open();
};


function manageRefillRequest(id, accept) {
    let card = document.getElementById('request-' + id);
    let url = '{{ url_for("refill_manage_request") }}';
    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            '{{ config["CSRF_HEADER_NAME"] }}': '{{ csrf_token() }}'
        },
        body: JSON.stringify({
            'id': id,
            'accept': accept
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data['error']) {
            M.toast({ html: data['message'] });
            return
        }
        if (data['ok']) {
            card.remove();
            M.toast({ html: data['message'] });
        } else {
            card.remove();
            M.toast({ html: data['message'] });
        }
    })
};
</script>
{% endblock %}